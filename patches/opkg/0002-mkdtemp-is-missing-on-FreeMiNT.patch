From 7fc971fdf119834326e8108a3efda2c42ec7d890 Mon Sep 17 00:00:00 2001
From: Miro Kropacek <miro.kropacek@gmail.com>
Date: Sun, 28 Apr 2019 17:17:52 +0200
Subject: [PATCH 2/2] mkdtemp() is missing on FreeMiNT

---
 libopkg/opkg.c         |  5 +++++
 libopkg/opkg_cmd.c     | 11 +++++++++++
 libopkg/opkg_conf.c    |  5 +++++
 libopkg/opkg_install.c |  5 +++++
 4 files changed, 26 insertions(+)

diff --git a/libopkg/opkg.c b/libopkg/opkg.c
index 3669b7e..cb98e5f 100644
--- a/libopkg/opkg.c
+++ b/libopkg/opkg.c
@@ -495,7 +495,12 @@ int opkg_update_package_lists(opkg_progress_callback_t progress_callback,
     }
 
     sprintf_alloc(&tmp, "%s/update-XXXXXX", opkg_config->tmp_dir);
+#ifndef __MINT__
     dtemp = mkdtemp(tmp);
+#else
+    dtemp = mktemp(tmp);
+    if (dtemp != NULL) mkdir(dtemp, 0700);
+#endif
     if (dtemp == NULL) {
         opkg_perror(ERROR, "Coundn't create temporary directory %s", tmp);
         free(tmp);
diff --git a/libopkg/opkg_cmd.c b/libopkg/opkg_cmd.c
index fd27062..24ed45b 100644
--- a/libopkg/opkg_cmd.c
+++ b/libopkg/opkg_cmd.c
@@ -20,6 +20,7 @@
 
 #include <stdio.h>
 #include <dirent.h>
+#include <sys/stat.h>
 #include <glob.h>
 #include <fnmatch.h>
 #include <signal.h>
@@ -106,7 +107,12 @@ static int opkg_update_cmd(int argc, char **argv)
     failures = 0;
 
     sprintf_alloc(&tmp, "%s/update-XXXXXX", opkg_config->tmp_dir);
+#ifndef __MINT__
     dtemp = mkdtemp(tmp);
+#else
+    dtemp = mktemp(tmp);
+    if (dtemp != NULL) mkdir(dtemp, 0700);
+#endif
     if (dtemp == NULL) {
         opkg_perror(ERROR, "Failed to make temp dir %s", opkg_config->tmp_dir);
         return -1;
@@ -182,7 +188,12 @@ static opkg_intercept_t opkg_prep_intercepts(void)
     sprintf_alloc(&ctx->statedir, "%s/opkg-intercept-XXXXXX",
                   opkg_config->tmp_dir);
 
+#ifndef __MINT__
     dtemp = mkdtemp(ctx->statedir);
+#else
+    dtemp = mktemp(ctx->statedir);
+    if (dtemp != NULL) mkdir(dtemp, 0700);
+#endif
     if (dtemp == NULL) {
         opkg_perror(ERROR, "Failed to make temp dir %s", ctx->statedir);
         free(ctx->oldpath);
diff --git a/libopkg/opkg_conf.c b/libopkg/opkg_conf.c
index 06880a1..340720d 100644
--- a/libopkg/opkg_conf.c
+++ b/libopkg/opkg_conf.c
@@ -769,7 +769,12 @@ int opkg_conf_load(void)
                   tmp_dir_base ? tmp_dir_base : OPKG_CONF_DEFAULT_TMP_DIR_BASE,
                   OPKG_CONF_TMP_DIR_SUFFIX);
     free(opkg_config->tmp_dir);
+#ifndef __MINT__
     opkg_config->tmp_dir = mkdtemp(tmp);
+#else
+    opkg_config->tmp_dir = mktemp(tmp);
+    if (opkg_config->tmp_dir != NULL) mkdir(opkg_config->tmp_dir, 0700);
+#endif
     if (opkg_config->tmp_dir == NULL) {
         opkg_perror(ERROR, "Creating temp dir %s failed", tmp);
         goto err3;
diff --git a/libopkg/opkg_install.c b/libopkg/opkg_install.c
index 585e7d8..ac7b08d 100644
--- a/libopkg/opkg_install.c
+++ b/libopkg/opkg_install.c
@@ -138,7 +138,12 @@ static int unpack_pkg_control_files(pkg_t * pkg)
     sprintf_alloc(&pkg->tmp_unpack_dir, "%s/%s-XXXXXX", opkg_config->tmp_dir,
                   pkg->name);
 
+#ifndef __MINT__
     pkg->tmp_unpack_dir = mkdtemp(pkg->tmp_unpack_dir);
+#else
+    pkg->tmp_unpack_dir = mktemp(pkg->tmp_unpack_dir);
+    if (pkg->tmp_unpack_dir != NULL) mkdir(pkg->tmp_unpack_dir, 0700);
+#endif
     if (pkg->tmp_unpack_dir == NULL) {
         opkg_perror(ERROR, "Failed to create temporary directory '%s'",
                     pkg->tmp_unpack_dir);
-- 
2.20.1

